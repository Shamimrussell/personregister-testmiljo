name: Build and Test

on: [push, pull_request]

jobs:
  python-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Check dependencies
      run: |
        # Check if requirements.txt exists
        if [ ! -f "requirements.txt" ]; then
          echo "requirements.txt not found, creating one..."
          echo "Faker==25.0.0" > requirements.txt
        fi
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Syntax and import test
      run: |
        python -m py_compile app.py show_users.py
        echo "✅ Syntax check passed"
        
        python -c "
import sqlite3
import os
from faker import Faker
print('✅ All imports successful')
        "
    
    - name: Functional test
      run: |
        python -c "
import app
# Test database functions without side effects
print('Testing module import...')
app.init_database()
print('✅ Database initialization works')
        "
  
  docker-test:
    runs-on: ubuntu-latest
    needs: python-test  # Kör först efter python-test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -t personregister-test .
        echo "✅ Docker build successful"
    
    - name: Check Dockerfile and docker-compose
      run: |
        if [ -f "Dockerfile" ]; then
          echo "✅ Dockerfile exists"
        else
          echo "❌ Dockerfile missing"
          exit 1
        fi
        
        if [ -f "docker-compose.yml" ]; then
          echo "✅ docker-compose.yml exists"
        else
          echo "⚠️  docker-compose.yml missing (optional)"
        fi